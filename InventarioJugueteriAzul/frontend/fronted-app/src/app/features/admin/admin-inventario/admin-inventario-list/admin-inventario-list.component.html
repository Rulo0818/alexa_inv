<div class="filters">
  <input
    type="text"
    class="search-input"
    [ngModel]="searchText()"
    (ngModelChange)="searchText.set($event)"
    (keyup.enter)="onSearch()"
    placeholder="Buscar por nombre, ID o código..."
  />
  <select
    class="category-select"
    [ngModel]="categoriaFiltro() ?? ''"
    (ngModelChange)="onCategoriaChange($event)"
  >
    <option value="">Todas las categorías</option>
    @for (c of categorias(); track c.id) {
      <option [value]="c.id">{{ c.emoji || '•' }} {{ c.nombre }}</option>
    }
  </select>
  <button type="button" class="btn btn-search" (click)="onSearch()">Buscar</button>
</div>

@if (mensaje()) {
  <p class="msg" [class.error]="mensaje()?.tipo === 'error'">{{ mensaje()?.text }}</p>
}

<div class="table-wrap">
  @if (loading()) {
    <p class="loading">Cargando productos…</p>
  } @else {
    <table class="product-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>PRODUCTO</th>
          <th>CATEGORÍA</th>
          <th>COMPRA</th>
          <th>VENTA</th>
          <th>STOCK</th>
          <th>ESTADO</th>
          <th>REBAJAS</th>
          <th>ACCIONES</th>
        </tr>
      </thead>
      <tbody>
        @for (p of productos(); track p.id) {
          <tr>
            <td>{{ p.codigo }}</td>
            <td>{{ p.nombre }}</td>
            <td>{{ p.emoji_categoria || '' }} {{ p.nombre_categoria }}</td>
            <td>{{ formatMoney(p.precio_de_compra) }}</td>
            <td>{{ formatMoney(p.precio_de_venta) }}</td>
            <td [class.stock-cero]="p.stock === 0">{{ p.stock }}</td>
            <td>
              <span class="estado-badge" [class.bueno]="p.estado === 'bueno'" [class.malo]="p.estado === 'malo'">
                {{ p.estado === 'bueno' ? 'Bueno' : 'Malo' }}
              </span>
            </td>
            <td [class.rebaja]="p.descuento_porcentaje > 0">{{ p.descuento_porcentaje }}%</td>
            <td>
              <button type="button" class="btn-sm btn-edit" (click)="editar(p)">Editar</button>
              <button type="button" class="btn-sm btn-delete" (click)="eliminar(p)">Eliminar</button>
            </td>
          </tr>
        }
        @empty {
          <tr>
            <td colspan="9">No hay productos</td>
          </tr>
        }
      </tbody>
    </table>
  }
</div>
