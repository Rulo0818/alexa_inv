<div class="nueva-venta-page">
  <!-- Stats -->
  <div class="stats-row">
    <div class="stat-card">
      <h3>MIS VENTAS HOY</h3>
      <p class="stat-value">{{ loadingStats() ? '‚Äî' : ventasHoy() }}</p>
    </div>
    <div class="stat-card">
      <h3>CU√ÅNTO LLEVA VENDIDO</h3>
      <p class="stat-value">{{ loadingStats() ? '‚Äî' : formatMoney(totalVendidoHistorico()) }}</p>
    </div>
    <div class="stat-card">
      <h3>√öLTIMA VENTA</h3>
      <p class="stat-value">{{ ultimaVenta() ?? '‚Äî' }}</p>
    </div>
  </div>

  <!-- Nueva Venta -->
  <section class="section nueva-venta">
    <h2>üõí Nueva Venta</h2>
    <p class="section-desc">Busca productos por nombre, c√≥digo o categor√≠a</p>

    <div class="category-pills">
      <button
        type="button"
        class="pill"
        [class.active]="categoriaSeleccionada() === null"
        (click)="seleccionarCategoria(null)"
      >
        Todos
      </button>
      @for (c of categorias(); track c.id) {
        <button
          type="button"
          class="pill"
          [class.active]="categoriaSeleccionada() === c.id"
          (click)="seleccionarCategoria(c.id)"
        >
          {{ c.emoji || '‚Ä¢' }} {{ c.nombre }}
        </button>
      }
    </div>

    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input
        type="text"
        [value]="searchText()"
        (input)="onSearchChange($any($event.target).value)"
        placeholder="Buscar por nombre (ej: barbie) o c√≥digo (ej: J012)..."
      />
    </div>
    <p class="hint">Escribe en el buscador o selecciona una categor√≠a para ver productos</p>

    @if (!loadingProductos() && productos().length > 0) {
      <div class="productos-grid">
        @for (p of productos(); track p.id) {
          <button
            type="button"
            class="producto-card"
            [disabled]="p.stock < 1"
            (click)="agregarAlCarrito(p)"
          >
            <span class="prod-emoji">{{ p.emoji_categoria || 'üì¶' }}</span>
            <span class="prod-nombre">{{ p.nombre }}</span>
            <span class="prod-precio">{{ formatMoney(p.precio_de_venta) }}</span>
            @if (p.stock < 1) {
              <span class="prod-stock">Sin stock</span>
            }
          </button>
        }
      </div>
    }
    @if (!loadingProductos() && productos().length === 0) {
      <p class="empty-hint">No hay productos para mostrar</p>
    }
  </section>

  <!-- Carrito -->
  <section class="section carrito">
    <h2>üõí Carrito de venta</h2>
    @if (carrito().length === 0) {
      <p class="cart-empty">El carrito est√° vac√≠o. Agrega productos para comenzar.</p>
    } @else {
      <ul class="cart-list">
        @for (item of carrito(); track item.id_producto) {
          <li class="cart-item">
            <span class="cart-item-name">{{ item.nombre }}</span>
            <span class="cart-item-qty">
              <button type="button" (click)="ajustarCantidad(item.id_producto, -1)">‚àí</button>
              {{ item.cantidad }}
              <button type="button" (click)="ajustarCantidad(item.id_producto, 1)">+</button>
            </span>
            <span class="cart-item-price">{{ formatMoney(item.subtotal) }}</span>
            <button type="button" class="btn-remove" (click)="quitarDelCarrito(item.id_producto)">
              ‚úï
            </button>
          </li>
        }
      </ul>
    }
  </section>

  <!-- M√©todo de pago -->
  <section class="section pago">
    <h2>üí≥ M√©todo de pago</h2>
    <div class="payment-buttons">
      <button
        type="button"
        class="payment-btn"
        [class.active]="metodoPago() === 'efectivo'"
        (click)="metodoPago.set('efectivo')"
      >
        <span class="payment-icon">üíµ</span>
        Efectivo
      </button>
      <button
        type="button"
        class="payment-btn"
        [class.active]="metodoPago() === 'transferencia'"
        (click)="metodoPago.set('transferencia')"
      >
        <span class="payment-icon">üè¶</span>
        Transferencia
      </button>
    </div>
  </section>

  <!-- Total y finalizar -->
  <div class="totales">
    <p>Subtotal: {{ formatMoney(subtotal()) }}</p>
    <div class="total-bar">
      <span>TOTAL: {{ formatMoney(subtotal()) }}</span>
    </div>
    @if (mensaje()) {
      <p class="msg" [class.error]="mensaje()?.tipo === 'error'">{{ mensaje()?.text }}</p>
    }
    <button
      type="button"
      class="btn-finalizar"
      [disabled]="carrito().length === 0 || finalizando()"
      (click)="finalizarVenta()"
    >
      ‚úì Finalizar Venta
    </button>
  </div>
</div>
